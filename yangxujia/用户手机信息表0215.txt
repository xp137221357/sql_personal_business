

-- 创建表
CREATE TABLE `t_user_mobile_0215` (
	`USER_ID` BIGINT(19) NOT NULL AUTO_INCREMENT,
	`USER_CODE` VARCHAR(100) NULL DEFAULT NULL,
	`CRT_TIME` DATETIME NULL DEFAULT NULL,
	`DEVICE_CODE` VARCHAR(100) NULL DEFAULT NULL,
	`CHANNEL_NO` VARCHAR(50) NULL DEFAULT NULL,
	`MOBILE_VERSION` VARCHAR(150) NULL DEFAULT NULL,
	`MOBILE_BRAND` VARCHAR(50) NULL DEFAULT NULL,
	PRIMARY KEY (`USER_ID`),
	INDEX `USER_CODE` (`USER_CODE`),
	INDEX `MOBILE_VERSION` (`MOBILE_VERSION`),
	INDEX `MOBILE_BRAND` (`MOBILE_BRAND`),
)
COLLATE='utf8_general_ci'
ENGINE=InnoDB
AUTO_INCREMENT=1
;


-- 刷数据

BEGIN
DECLARE ssql VARCHAR(10000);
SET @rownums=0;
SET ssql="
INSERT into report.t_user_moblie_0215(USER_ID, USER_CODE, CRT_TIME,DEVICE_CODE,CHANNEL_NO,MOBILE_VERSION,MOBILE_BRAND)
select u.USER_ID,u.USER_CODE,u.CRT_TIME,te.DEVICE_CODE,te.CHANNEL_NO,ti.MOBILE_VERSION,ti.MOBILE_BRAND from forum.t_user_event te 
inner join (select USER_ID,user_code,CRT_TIME from forum.t_user where CLIENT_ID = 'BYAPP' limit ?,1000) u
 on te.USER_ID=u.user_id and te.EVENT_CODE='reg'
left join forum.t_device_info ti on te.DEVICE_CODE=ti.DEVICE_CODE
on duplicate key update 
CHANNEL_NO = values(CHANNEL_NO),
DEVICE_CODE = values(DEVICE_CODE),
MOBILE_VERSION = values(MOBILE_VERSION),
MOBILE_BRAND = values(MOBILE_BRAND)
";
while @rownums<500000 do
SET @SQUERY=ssql;
PREPARE STMT FROM @SQUERY;
EXECUTE STMT USING @rownums;
SET @rownums=@rownums+1000;
end while;
END