
-- 汇总


insert into t_inner_user(user_id,item_event,sender,receiver,coins)
select t.sender,'答题',t.sender,t.receiver,sum(t.coins) coins from (
-- 第三方出题，用户答题，用户给第三方金币
select '答题',u2.USER_ID sender,u.user_id receiver, IFNULL(o.OFFER_GRATUITY,0) - IFNULL(o.OFFER_PRIZE,0) coins
from game.t_offer_apply oa 
inner join game.t_offer o on o.OFFER_ID = oa.OFFER_ID and o.OFFER_STATUS = 20 and o.IS_FINISH = 1
inner join forum.t_user u on oa.USER_ID = u.USER_CODE 
inner join forum.t_user u2 on o.USER_ID = u2.USER_CODE and 
(u.ACCT_NUM in (
'13468818',
'13469055',
'13469064',
'13468995',
'11133239',
'12657149',
'12793811',
'13180578',
'13234098',
'11010347',
'12598085',
'12796487',
'13154904',
'12991293',
'13165038',
'13570425',
'13362918',
'13373340',
'13267623',
'13469055',
'13468107',
'13231983',
'13298766',
'13325967',
'13468053',
'13267134',
'13121838',
'13121841',
'13121862',
'13468818',
'13995651',
'13331511',
'13339272',
'13469064',
'13233816',
'13234098',
'13499265',
'11042243',
'13183356',
'13520685',
'12657149',
'13530591',
'13470360',
'13322229',
'13322238',
'13322244',
'13468995',
'13268982',
'13180578',
'13482720',
'12793811'
) or u2.ACCT_NUM in (
'13468818',
'13469055',
'13469064',
'13468995',
'11133239',
'12657149',
'12793811',
'13180578',
'13234098',
'11010347',
'12598085',
'12796487',
'13154904',
'12991293',
'13165038',
'13570425',
'13362918',
'13373340',
'13267623',
'13469055',
'13468107',
'13231983',
'13298766',
'13325967',
'13468053',
'13267134',
'13121838',
'13121841',
'13121862',
'13468818',
'13995651',
'13331511',
'13339272',
'13469064',
'13233816',
'13234098',
'13499265',
'11042243',
'13183356',
'13520685',
'12657149',
'13530591',
'13470360',
'13322229',
'13322238',
'13322244',
'13468995',
'13268982',
'13180578',
'13482720',
'12793811'
))

union all 		 

-- 用户出题，第三方答题，用户给第三方金币
select '答题',u2.USER_ID sender,u.USER_ID receiver, IFNULL(o.OFFER_PRIZE,0) - IFNULL(o.OFFER_GRATUITY,0) coins
from game.t_offer_apply oa 
inner join game.t_offer o on o.OFFER_ID = oa.OFFER_ID and o.OFFER_STATUS = 80 and o.IS_FINISH = 1
inner join forum.t_user u on o.USER_ID = u.USER_CODE
inner join forum.t_user u2 on oa.USER_ID = u2.USER_CODE and (
u.ACCT_NUM in (
'13468818',
'13469055',
'13469064',
'13468995',
'11133239',
'12657149',
'12793811',
'13180578',
'13234098',
'11010347',
'12598085',
'12796487',
'13154904',
'12991293',
'13165038',
'13570425',
'13362918',
'13373340',
'13267623',
'13469055',
'13468107',
'13231983',
'13298766',
'13325967',
'13468053',
'13267134',
'13121838',
'13121841',
'13121862',
'13468818',
'13995651',
'13331511',
'13339272',
'13469064',
'13233816',
'13234098',
'13499265',
'11042243',
'13183356',
'13520685',
'12657149',
'13530591',
'13470360',
'13322229',
'13322238',
'13322244',
'13468995',
'13268982',
'13180578',
'13482720',
'12793811'
) or u2.ACCT_NUM in (
'13468818',
'13469055',
'13469064',
'13468995',
'11133239',
'12657149',
'12793811',
'13180578',
'13234098',
'11010347',
'12598085',
'12796487',
'13154904',
'12991293',
'13165038',
'13570425',
'13362918',
'13373340',
'13267623',
'13469055',
'13468107',
'13231983',
'13298766',
'13325967',
'13468053',
'13267134',
'13121838',
'13121841',
'13121862',
'13468818',
'13995651',
'13331511',
'13339272',
'13469064',
'13233816',
'13234098',
'13499265',
'11042243',
'13183356',
'13520685',
'12657149',
'13530591',
'13470360',
'13322229',
'13322238',
'13322244',
'13468995',
'13268982',
'13180578',
'13482720',
'12793811'
))
) t group by t.sender,t.receiver
on duplicate key update 
coins = values(coins);


-- 转账
insert into t_inner_user(user_id,item_event,sender,receiver,coins)
select sender,'转账',t.sender,t.receiver,sum(t.MONEY) coins from 
(
SELECT t.user_id sender,t.tuser_id receiver,t.MONEY
FROM forum.t_user_present t
inner join forum.t_user u on t.USER_ID=u.USER_ID and u.ACCT_NUM in (

'13468818',
'13469055',
'13469064',
'13468995',
'11133239',
'12657149',
'12793811',
'13180578',
'13234098',
'11010347',
'12598085',
'12796487',
'13154904',
'12991293',
'13165038',
'13570425',
'13362918',
'13373340',
'13267623',
'13469055',
'13468107',
'13231983',
'13298766',
'13325967',
'13468053',
'13267134',
'13121838',
'13121841',
'13121862',
'13468818',
'13995651',
'13331511',
'13339272',
'13469064',
'13233816',
'13234098',
'13499265',
'11042243',
'13183356',
'13520685',
'12657149',
'13530591',
'13470360',
'13322229',
'13322238',
'13322244',
'13468995',
'13268982',
'13180578',
'13482720',
'12793811'

)

union all 

SELECT t.user_id sender,t.tuser_id receiver,t.MONEY
FROM forum.t_user_present t
inner join forum.t_user u on t.TUSER_ID=u.USER_ID and u.ACCT_NUM in (

'13468818',
'13469055',
'13469064',
'13468995',
'11133239',
'12657149',
'12793811',
'13180578',
'13234098',
'11010347',
'12598085',
'12796487',
'13154904',
'12991293',
'13165038',
'13570425',
'13362918',
'13373340',
'13267623',
'13469055',
'13468107',
'13231983',
'13298766',
'13325967',
'13468053',
'13267134',
'13121838',
'13121841',
'13121862',
'13468818',
'13995651',
'13331511',
'13339272',
'13469064',
'13233816',
'13234098',
'13499265',
'11042243',
'13183356',
'13520685',
'12657149',
'13530591',
'13470360',
'13322229',
'13322238',
'13322244',
'13468995',
'13268982',
'13180578',
'13482720',
'12793811'

)
) t
group by t.sender,t.receiver
on duplicate key update 
coins = values(coins);

-- 红包
insert into t_inner_user(user_id,item_event,sender,receiver,coins)
select u1.user_id,'红包',u1.USER_ID sender,u2.USER_ID receiver,round(sum(t.TOTAL_MONEY)) coins from game.t_packet_item o
inner join game.t_packets t on o.PACKET_ID=t.ID 
inner join forum.t_user u1 on t.USER_ID=u1.USER_CODE and u1.ACCT_NUM in (
'13468818',
'13469055',
'13469064',
'13468995',
'11133239',
'12657149',
'12793811',
'13180578',
'13234098',
'11010347',
'12598085',
'12796487',
'13154904',
'12991293',
'13165038',
'13570425',
'13362918',
'13373340',
'13267623',
'13469055',
'13468107',
'13231983',
'13298766',
'13325967',
'13468053',
'13267134',
'13121838',
'13121841',
'13121862',
'13468818',
'13995651',
'13331511',
'13339272',
'13469064',
'13233816',
'13234098',
'13499265',
'11042243',
'13183356',
'13520685',
'12657149',
'13530591',
'13470360',
'13322229',
'13322238',
'13322244',
'13468995',
'13268982',
'13180578',
'13482720',
'12793811')
inner join forum.t_user u2 on o.RECIVE_USER=u2.USER_CODE 
group by o.RECIVE_USER
on duplicate key update 
coins = values(coins);

-- pk场
insert into t_inner_user(user_id,item_event,sender,receiver,coins)
select u1.user_id,'pk场',u1.USER_ID sender,u2.USER_ID receiver,ifnull(sum(t.PRIZE_MONEY),0)+ifnull(sum(t.RETURN_MONEY),0)-ifnull(sum(t.ITEM_MONEY),0) coins
from game.t_room_user tu
inner join forum.t_user u1 on tu.USER_ID=u1.USER_CODE and u1.ACCT_NUM in (
'13468818',
'13469055',
'13469064',
'13468995',
'11133239',
'12657149',
'12793811',
'13180578',
'13234098',
'11010347',
'12598085',
'12796487',
'13154904',
'12991293',
'13165038',
'13570425',
'13362918',
'13373340',
'13267623',
'13469055',
'13468107',
'13231983',
'13298766',
'13325967',
'13468053',
'13267134',
'13121838',
'13121841',
'13121862',
'13468818',
'13995651',
'13331511',
'13339272',
'13469064',
'13233816',
'13234098',
'13499265',
'11042243',
'13183356',
'13520685',
'12657149',
'13530591',
'13470360',
'13322229',
'13322238',
'13322244',
'13468995',
'13268982',
'13180578',
'13482720',
'12793811'
)
inner join game.t_clubs_order t on tu.ROOM_ID=t.CLUBS_INFO_ID
inner join forum.t_user u2 on t.USER_ID=u2.USER_CODE 
group by u2.USER_ID
on duplicate key update 
coins = values(coins);
